delete from `gcp-wow-ent-im-tbl-$appEnv.adp_config_data.export_job_parameter`  where pattern  = 'batch_export_adp_article'
INSERT INTO `gcp-wow-ent-im-tbl-$appEnv.adp_config_data.export_job_parameter` (pattern,lookupWatermark,format,delimiter,compression,printHeader,outputFileName,outputGCSlocation,export_sql,pre_sql)values ('batch_export_adp_article','Y','CSV','~','GZIP',TRUE,'adp_article','adp_target_quantium_$appEnv/data',"select * from `$projectId.adp_etl_stg.export_qtm_adp_article` where update_dttm between '$start_dttm' and '$end_dttm'  ",["MERGE INTO `$projectId.adp_etl_stg.export_qtm_adp_article` t using ( SELECT COALESCE(art_hier.salesorg,'') AS salesorg,COALESCE(art.itemid,'') AS itemid,COALESCE(art.description,'') AS description,COALESCE(art_hier.dept,'') AS dept,COALESCE(art_hier.dept_name,'') AS dept_name,COALESCE(art_hier.category,'') AS category,COALESCE(art_hier.category_name,'') AS category_name,COALESCE(art_hier.subcategory,'') AS subcategory,COALESCE(art_hier.subcategory_name,'') AS subcategory_name,COALESCE(art_hier.segment,'') AS segment,COALESCE(art_hier.segment_name,'') AS segment_name,COALESCE(art.salesuom,'') AS salesuom,COALESCE(art_hier.gm_name,'') AS gm_name,COALESCE(art_hier.gm_cd,'') AS gm_cd,COALESCE(art_hier.mm_name,'') AS mm_name,COALESCE(art_hier.mm_cd,'') AS mm_cd,COALESCE(art_hier.cm_name,'') AS cm_name,COALESCE(art_hier.cm_cd,'') AS cm_cd,COALESCE(art.onlinedescription,'') AS onlinedescription,COALESCE(art.piuom,'') AS piuom,COALESCE(art.plucode,'') AS plucode,COALESCE(art.randomweightflag,'') AS randomweightflag,COALESCE(art.taxclass,'') AS taxclass,COALESCE(art.weighteditem,'') AS weighteditem,COALESCE(art.brand,'') AS brand,COALESCE(art.brand_description,'') AS brand_description,COALESCE(art.brand_type,'') AS brand_type,COALESCE (pf_2.pricefamily,pf_1.pricefamily,art.itemid ) AS pricefamily_psuedo,COALESCE (pf_2.group_description,pf_1.group_description,art.description ) AS pricefamily_desc_psuedo,COALESCE (pf_2.pricefamily,pf_1.pricefamily) AS pricefamily_code,COALESCE (pf_2.group_description,pf_1.group_description) AS pricefamily_desc,'' AS food_co_flag,'$processing_dttm' AS load_dttm, '$processing_dttm' AS update_dttm FROM ( SELECT * EXCEPT (rnum) FROM ( SELECT itemid, description, salesuom, onlinedescription, piuom, plucode, randomweightflag, taxclass, weighteditem, brand, brand_description, brand_type, '$processing_dttm' AS load_dttm, '$processing_dttm' AS update_dttm, row_number() OVER ( partition BY itemid ORDER BY edh_start_dttm DESC ) AS rnum FROM  `$projectId.adp_master_curr.dim_article` WHERE    edh_end_dttm = '2099-12-31 00:00:00' )k WHERE  k.rnum=1 )art INNER JOIN ( SELECT * EXCEPT (rnum) FROM ( SELECT   *, row_number() OVER ( partition BY salesorg,itemid ORDER BY edh_start_dttm DESC ) AS rnum FROM  `$projectId.adp_master_curr.dim_article_hierarchy` WHERE  edh_end_dttm ='2099-12-31 00:00:00' AND salesorg IN ('1005', '1030', '1010', '1015'))m WHERE  m.rnum=1) art_hier ON art.itemid = art_hier.itemid LEFT OUTER JOIN ( SELECT DISTINCT f.pricefamily, f.articlenumber, f.salesorg, f.group_description FROM ( SELECT p.pricefamily,a.articlenumber,so.salesorg ,p.group_description,row_number() OVER ( partition BY articlenumber,salesorg ORDER BY COALESCE ( a.edh_start_dttm,'1900-01-01 00:00:00') DESC , COALESCE ( so.edh_start_dttm,'1900-01-01 00:00:00') DESC , COALESCE (p.edh_start_dttm,'1900-01-01 00:00:00')DESC ) AS row_num FROM ( SELECT * FROM   `$projectId.adp_master_curr.dim_pricefamily` WHERE  edh_end_dttm ='2099-12-31 00:00:00') p INNER JOIN ( SELECT * FROM   `$projectId.adp_master_curr.dim_pricefamily_relation` WHERE  edh_end_dttm ='2099-12-31 00:00:00')so ON p.pricefamily = so.pricefamily AND  p.group_name = so.group_name LEFT OUTER JOIN ( SELECT * FROM   `$projectId.adp_master_curr.dim_pricefamily_article` WHERE  edh_end_dttm ='2099-12-31 00:00:00') a ON  p.pricefamily = a.pricefamily AND p.group_name = a.group_name )f WHERE row_num=1 ) pf_1 ON pf_1.articlenumber= art.itemid AND pf_1.salesorg = art_hier.salesorg LEFT OUTER JOIN (  SELECT DISTINCT f.pricefamily, f.masterarticle, f.salesorg, f.group_description  FROM (  SELECT p.pricefamily, p.masterarticle, so.salesorg , p.group_description, row_number() OVER ( partition BY masterarticle,salesorg ORDER BY COALESCE ( p.edh_start_dttm,'1900-01-01 00:00:00') DESC ,  COALESCE (so.edh_start_dttm,'1900-01-01 00:00:00')DESC ) AS row_num  FROM  (SELECT pricefamily, group_description, masterarticle, group_name , edh_start_dttm  FROM   `$projectId.adp_master_curr.dim_pricefamily` WHERE  edh_end_dttm ='2099-12-31 00:00:00') p INNER JOIN ( SELECT pricefamily, group_name, salesorg,edh_start_dttm  FROM   `$projectId.adp_master_curr.dim_pricefamily_relation`  WHERE  edh_end_dttm ='2099-12-31 00:00:00')so ON p.pricefamily = so.pricefamily  AND p.group_name = so.group_name  )f  WHERE row_num=1 ) pf_2 ON pf_2.masterarticle= art.itemid AND pf_2.salesorg = art_hier.salesorg) s ON COALESCE(s.salesorg,'') = COALESCE(t.salesorg,'') AND COALESCE(s.itemid,'') = COALESCE(t.itemid,'') WHEN matched AND ( COALESCE(s.description,'') <> COALESCE(t.description,'') OR  COALESCE(s.dept,'') <> COALESCE(t.dept,'') OR  COALESCE(s.dept_name,'') <> COALESCE(t.dept_name,'') OR  COALESCE(s.category,'') <> COALESCE(t.category,'') OR  COALESCE(s.category_name,'') <> COALESCE(t.category_name,'') OR  COALESCE(s.subcategory,'') <> COALESCE(t.subcategory,'') OR COALESCE(s.subcategory_name,'') <> COALESCE(t.subcategory_name,'') OR  COALESCE(s.segment,'') <> COALESCE(t.segment,'') OR  COALESCE(s.segment_name,'') <> COALESCE(t.segment_name,'') OR  COALESCE(s.salesuom,'') <> COALESCE(t.salesuom,'') OR  COALESCE(s.gm_name,'') <> COALESCE(t.gm_name,'') OR  COALESCE(s.gm_cd,'') <> COALESCE(t.gm_cd,'') OR  COALESCE(s.mm_name,'') <> COALESCE(t.mm_name,'') OR  COALESCE(s.mm_cd,'') <> COALESCE(t.mm_cd,'') OR  COALESCE(s.cm_name,'') <> COALESCE(t.cm_name,'') OR  COALESCE(s.cm_cd,'') <> COALESCE(t.cm_cd,'') OR  COALESCE(s.onlinedescription,'') <> COALESCE(t.onlinedescription,'') OR  COALESCE(s.piuom,'') <> COALESCE(t.piuom,'') OR  COALESCE(s.plucode,'') <> COALESCE(t.plucode,'') OR  COALESCE(s.randomweightflag,'') <> COALESCE(t.randomweightflag,'') OR  COALESCE(s.taxclass,'') <> COALESCE(t.taxclass,'') OR  COALESCE(s.weighteditem,'') <> COALESCE(t.weighteditem,'') OR  COALESCE(s.brand,'') <> COALESCE(t.brand,'') OR  COALESCE(s.brand_description,'') <> COALESCE(t.brand_description,'') OR  COALESCE(s.brand_type,'') <> COALESCE(t.brand_type,'') OR  COALESCE(s.pricefamily_psuedo,'') <> COALESCE(t.pricefamily_psuedo,'') OR  COALESCE(s.pricefamily_desc_psuedo,'') <> COALESCE(t.pricefamily_desc_psuedo,'') OR  COALESCE(s.pricefamily_code,'') <> COALESCE(t.pricefamily_code,'') OR  COALESCE(s.pricefamily_desc,'') <> COALESCE(t.pricefamily_desc,'') OR  COALESCE(s.food_co_flag,'') <> COALESCE(t.food_co_flag,'') ) THEN UPDATE SET t.salesorg = s.salesorg, t.itemid = s.itemid, t.description = s.description, t.dept = s.dept, t.dept_name = s.dept_name, t.category = s.category, t.category_name = s.category_name, t.subcategory = s.subcategory, t.subcategory_name = s.subcategory_name, t.segment = s.segment, t.segment_name = s.segment_name, t.salesuom = s.salesuom, t.gm_name = s.gm_name, t.gm_cd = s.gm_cd, t.mm_name = s.mm_name, t.mm_cd = s.mm_cd, t.cm_name = s.cm_name, t.cm_cd = s.cm_cd, t.onlinedescription = s.onlinedescription, t.piuom = s.piuom, t.plucode = s.plucode, t.randomweightflag = s.randomweightflag, t.taxclass = s.taxclass, t.weighteditem = s.weighteditem, t.brand = s.brand, t.brand_description = s.brand_description, t.brand_type = s.brand_type, t.pricefamily_psuedo = s.pricefamily_psuedo, t.pricefamily_desc_psuedo = s.pricefamily_desc_psuedo, t.pricefamily_code = s.pricefamily_code, t.pricefamily_desc = s.pricefamily_desc, t.food_co_flag = s.food_co_flag, t.update_dttm = '$processing_dttm' WHEN NOT matched THEN INSERT ( salesorg, itemid, description, dept, dept_name, category, category_name, subcategory, subcategory_name, segment, segment_name, salesuom, gm_name, gm_cd, mm_name, mm_cd, cm_name, cm_cd, onlinedescription, piuom, plucode, randomweightflag, taxclass, weighteditem, brand, brand_description, brand_type, pricefamily_psuedo, pricefamily_desc_psuedo, pricefamily_code, pricefamily_desc, food_co_flag, load_dttm, update_dttm ) VALUES ( salesorg,itemid, description, dept, dept_name, category, category_name, subcategory, subcategory_name, segment, segment_name, salesuom, gm_name, gm_cd, mm_name, mm_cd, cm_name, cm_cd, onlinedescription, piuom, plucode, randomweightflag, taxclass, weighteditem, brand, brand_description, brand_type, pricefamily_psuedo, pricefamily_desc_psuedo, pricefamily_code, pricefamily_desc, food_co_flag, '$processing_dttm' , '$processing_dttm' )"])
